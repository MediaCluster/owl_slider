{namespace owl=TYPO3\OwlSlider\ViewHelpers}

<div id="{f:if(condition:'{settings.slider_id}',then:'sync1_{settings.slider_id}',else:'sync1')}" class="owl-carousel">
  <f:for each="{items}" as="item">
    <div class="item">
      <f:if condition="{item.itemimage}">
        <f:if condition="{item.itemlink}">
          <f:then>
            <owl:typolink parameter="{item.itemlink}">
              <f:image class="lazyOwl" src="uploads/tx_owlslider/{item.itemimage}" height="{settings.slideHeight}" alt="{item.itemname}" />
            </owl:typolink>
          </f:then>
          <f:else>
            <f:image class="lazyOwl" src="uploads/tx_owlslider/{item.itemimage}" height="{settings.slideHeight}" alt="{item.itemname}" />
          </f:else>
        </f:if>
      </f:if>
    </div>
  </f:for>
</div>

<div id="{f:if(condition:'{settings.slider_id}',then:'sync2_{settings.slider_id}',else:'sync2')}" class="owl-carousel">
  <f:for each="{items}" as="item">
    <f:if condition="{item.itemcontent}">
      <div class="item">
        <f:format.html>{item.itemcontent}</f:format.html>
      </div>
    </f:if>
  </f:for>
</div>

<owl:addJsFooterInlineCode name="owlslider_{settings.slider_id}">
  jQuery(document).ready(function() {
    var sync1 = '{settings.slider_id}' ? jQuery('#sync1_{settings.slider_id}') : jQuery('#sync1');
    var sync2 = '{settings.slider_id}' ? jQuery('#sync2_{settings.slider_id}') : jQuery('#sync2');

    sync1.owlCarousel({
      items:                  1,
      itemsDesktop:           false,
      itemsDesktopSmall:      false,
      itemsTablet:            false,
      itemsTabletSmall:       false,
      itemsMobile:            false,
      itemsCustom:            false,
      singleItem:             true,
      itemsScaleUp:           <f:format.raw value="{settings.itemsScaleUp}" />,
      slideSpeed:             <f:format.raw value="{settings.slideSpeed}" />,
      paginationSpeed:        <f:format.raw value="{settings.paginationSpeed}" />,
      rewindSpeed:            <f:format.raw value="{settings.rewindSpeed}" />,
      autoPlay:               <f:format.raw value="{settings.autoPlay}" />,
      stopOnHover:            <f:format.raw value="{settings.stopOnHover}" />,
      navigation:             <f:format.raw value="{settings.navigation}" />,
      navigationText:         <f:format.raw value="{settings.navigationText}" />,
      rewindNav:              <f:format.raw value="{settings.rewindNav}" />,
      scrollPerPage:          <f:format.raw value="{settings.scrollPerPage}" />,
      pagination:             <f:format.raw value="{settings.pagination}" />,
      paginationNumbers:      <f:format.raw value="{settings.paginationNumbers}" />,
      responsive:             <f:format.raw value="{settings.responsive}" />,
      responsiveBaseWidth:    <f:format.raw value="{settings.responsiveBaseWidth}" />,
      baseClass:              <f:format.raw value="{settings.baseClass}" />,
      theme:                  <f:format.raw value="{settings.theme}" />,
      lazyLoad:               <f:format.raw value="{settings.lazyLoad}" />,
      lazyFollow:             <f:format.raw value="{settings.lazyFollow}" />,
      lazyEffect:             <f:format.raw value="{settings.lazyEffect}" />,
      autoHeight:             <f:format.raw value="{settings.autoHeight}" />,
      dragBeforeAnimFinish:   <f:format.raw value="{settings.dragBeforeAnimFinish}" />,
      mouseDrag:              <f:format.raw value="{settings.mouseDrag}" />,
      touchDrag:              <f:format.raw value="{settings.touchDrag}" />,
      addClassActive:         <f:format.raw value="{settings.addClassActive}" />,
      beforeInit:             <f:format.raw value="{settings.random}" /> ? random(sync1) : '',
      transitionStyle:        <f:format.raw value="{settings.transitionStyle}" />,
      afterAction:            syncPosition,
      responsiveRefreshRate:  <f:format.raw value="{settings.responsiveRefreshRate}" />,
    });

    sync2.owlCarousel({
      items:                  <f:format.raw value="{items -> f:count()}" />,
      itemsDesktop:           <f:format.raw value="{settings.itemsDesktop}" />,
      itemsDesktopSmall:      <f:format.raw value="{settings.itemsDesktopSmall}" />,
      itemsTablet:            <f:format.raw value="{settings.itemsTablet}" />,
      itemsTabletSmall:       <f:format.raw value="{settings.itemsTabletSmall}" />,
      itemsMobile:            <f:format.raw value="{settings.itemsMobile}" />,
      itemsCustom:            <f:format.raw value="{settings.itemsCustom}" />,
      singleItem:             <f:format.raw value="{settings.singleItem}" />,
      itemsScaleUp:           <f:format.raw value="{settings.itemsScaleUp}" />,
      slideSpeed:             <f:format.raw value="{settings.slideSpeed}" />,
      paginationSpeed:        <f:format.raw value="{settings.paginationSpeed}" />,
      rewindSpeed:            <f:format.raw value="{settings.rewindSpeed}" />,
      autoPlay:               <f:format.raw value="{settings.autoPlay}" />,
      stopOnHover:            <f:format.raw value="{settings.stopOnHover}" />,
      navigation:             <f:format.raw value="{settings.navigation}" />,
      navigationText:         <f:format.raw value="{settings.navigationText}" />,
      rewindNav:              <f:format.raw value="{settings.rewindNav}" />,
      scrollPerPage:          <f:format.raw value="{settings.scrollPerPage}" />,
      pagination:             <f:format.raw value="{settings.pagination}" />,
      paginationNumbers:      <f:format.raw value="{settings.paginationNumbers}" />,
      responsive:             <f:format.raw value="{settings.responsive}" />,
      responsiveRefreshRate:  <f:format.raw value="{settings.responsiveRefreshRate}" />,
      responsiveBaseWidth:    <f:format.raw value="{settings.responsiveBaseWidth}" />,
      baseClass:              <f:format.raw value="{settings.baseClass}" />,
      theme:                  <f:format.raw value="{settings.theme}" />,
      lazyLoad:               <f:format.raw value="{settings.lazyLoad}" />,
      lazyFollow:             <f:format.raw value="{settings.lazyFollow}" />,
      lazyEffect:             <f:format.raw value="{settings.lazyEffect}" />,
      autoHeight:             <f:format.raw value="{settings.autoHeight}" />,
      dragBeforeAnimFinish:   <f:format.raw value="{settings.dragBeforeAnimFinish}" />,
      mouseDrag:              <f:format.raw value="{settings.mouseDrag}" />,
      touchDrag:              <f:format.raw value="{settings.touchDrag}" />,
      addClassActive:         <f:format.raw value="{settings.addClassActive}" />,
      beforeInit:             <f:format.raw value="{settings.random}" /> ? random(sync2) : '',
      transitionStyle:        false,
      afterInit:              function(el) { el.find('.owl-item').eq(0).addClass('synced'); }
    });

    //Sort random function
    function random(owlSelector){
      owlSelector.children().sort(function(){
        return Math.round(Math.random()) - 0.5;
      }).each(function(){
        $(this).appendTo(owlSelector);
      });
    }

    function syncPosition(el) {
      var current = this.currentItem;
      sync2
        .find('.owl-item')
        .removeClass('synced')
        .eq(current)
        .addClass('synced');

      if(sync2.data('owlCarousel') !== undefined) {
        center(current)
      }
    }

    sync2.on('click', '.owl-item', function(e) {
      e.preventDefault();
      var number = jQuery(this).data('owlItem');
      sync1.trigger('owl.goTo',number);
    });

    function center(number) {
      var sync2visible = sync2.data('owlCarousel').owl.userItems;
      var num = number;
      var found = false;
      for(var i in sync2visible) {
        if(num === sync2visible[i]) {
          var found = true;
        }
      }
      if(found === false) {
        if(num > sync2visible[sync2visible.length - 1]) {
          sync2.trigger('owl.goTo', num - sync2visible.length + 2)
        } else {
          if(num - 1 === -1) {
            num = 0;
          }
          sync2.trigger('owl.goTo', num);
        }
      } else if(num === sync2visible[sync2visible.length - 1]) {
        sync2.trigger('owl.goTo', sync2visible[1])
      } else if(num === sync2visible[0]) {
        sync2.trigger('owl.goTo', num - 1)
      }
    }
  });

  window.onload = function() {
    var anchorElements =
      document
        .getElementById('{settings.slider_id}' ? 'sync2_{settings.slider_id}' : 'sync2')
        .getElementsByTagName('a');

    for (var i in anchorElements) {
      anchorElements[i].onclick = function() {
        if(this.target === '') {
          window.open(this.href, '_self', false);
        } else {
          window.open(this.href, this.target);
        }
      }
    }
  }
</owl:addJsFooterInlineCode>
